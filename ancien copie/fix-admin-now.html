<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Fix Admin Accounts - BlackRaven</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #ff0;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #ff0;
        }
        .subtitle {
            text-align: center;
            color: #0ff;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .section {
            background: #111;
            border: 3px solid #0f0;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        .section h2 {
            color: #ff0;
            margin-top: 0;
            font-size: 1.5em;
        }
        button {
            background: linear-gradient(135deg, #0f0, #0a0);
            color: #000;
            border: none;
            padding: 15px 30px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin: 5px;
            border-radius: 5px;
            font-size: 1.1em;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.4);
        }
        button:hover {
            background: linear-gradient(135deg, #0ff, #0aa);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.6);
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .result {
            background: #222;
            border-left: 4px solid #0f0;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 13px;
        }
        .error {
            border-left-color: #f00;
            color: #f00;
        }
        .success {
            border-left-color: #0f0;
            color: #0f0;
        }
        .warning {
            border-left-color: #ff0;
            color: #ff0;
        }
        .credentials {
            background: #000;
            border: 2px solid #0ff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .credential-item {
            background: #111;
            border-left: 4px solid #0f0;
            padding: 15px;
            margin: 10px 0;
        }
        .credential-item h3 {
            color: #ff0;
            margin: 0 0 10px 0;
        }
        .credential-field {
            margin: 5px 0;
            color: #0ff;
        }
        .credential-field strong {
            color: #fff;
        }
        .spinner {
            border: 4px solid rgba(0, 255, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #0f0;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress {
            background: #222;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border: 2px solid #0f0;
        }
        .step {
            margin: 8px 0;
            padding: 5px;
        }
        .step.active {
            color: #ff0;
            font-weight: bold;
        }
        .step.done {
            color: #0f0;
        }
        .step::before {
            content: "‚ñ∏ ";
            color: #0f0;
        }
        .step.active::before {
            content: "‚ö° ";
            color: #ff0;
        }
        .step.done::before {
            content: "‚úì ";
            color: #0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß FIX ADMIN ACCOUNTS</h1>
        <div class="subtitle">Correction des identit√©s manquantes dans auth.identities</div>

        <div class="section">
            <h2>üìã Diagnostic du Probl√®me</h2>
            <div class="result warning">
‚ö†Ô∏è PROBL√àME IDENTIFI√â:

Les comptes suivants existent dans auth.users mais n'ont PAS d'identit√© dans auth.identities:
  ‚Ä¢ super_admin@k3pr0s.local
  ‚Ä¢ admin@k3pr0s.local
  ‚Ä¢ support@k3pr0s.local

Sans identit√©, Supabase Auth ne peut PAS authentifier ces utilisateurs.

SOLUTION:
Cette page va recr√©er ces comptes avec leurs identit√©s correctement configur√©es.
            </div>
        </div>

        <div class="section">
            <h2>üöÄ Ex√©cuter le Fix</h2>
            <button onclick="runFix()" id="fix-btn">
                üîß CORRIGER LES COMPTES ADMIN
            </button>
            <div id="progress"></div>
            <div id="fix-result"></div>
        </div>

        <div id="test-section" style="display: none;">
            <div class="section">
                <h2>‚úÖ Test de Connexion</h2>
                <button onclick="testLogin('super_admin@k3pr0s.local', 'SuperAdmin2025!')">
                    Test super_admin
                </button>
                <button onclick="testLogin('admin@k3pr0s.local', 'Admin2025!')">
                    Test admin
                </button>
                <button onclick="testLogin('support@k3pr0s.local', 'Support2025!')">
                    Test support
                </button>
                <div id="test-result"></div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wvfkdxdusqgzlehkcpdn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2ZmtkeGR1c3FnemxlaGtjcGRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAwNTgxMzYsImV4cCI6MjA0NTYzNDEzNn0.eLj4cZQD3f5jGG1YGTgJ7OoHB5SMVdBXMXvK-4s-K10';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(elementId, message, type = 'result') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = typeof message === 'object' ? JSON.stringify(message, null, 2) : message;
            element.appendChild(div);
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function showProgress(steps) {
            const progressDiv = document.getElementById('progress');
            progressDiv.innerHTML = '<div class="progress">' +
                steps.map(s => `<div class="step ${s.status}">${s.text}</div>`).join('') +
                '</div>';
        }

        async function runFix() {
            const btn = document.getElementById('fix-btn');
            btn.disabled = true;
            clearLog('fix-result');

            showProgress([
                { text: 'Connexion √† Supabase...', status: 'active' },
                { text: 'Analyse des comptes existants', status: '' },
                { text: 'Suppression des comptes cass√©s', status: '' },
                { text: 'Recr√©ation avec identit√©s valides', status: '' },
                { text: 'Configuration des r√¥les admin', status: '' },
                { text: 'V√©rification finale', status: '' }
            ]);

            try {
                log('fix-result', 'üöÄ Lancement de la correction...', 'warning');
                log('fix-result', 'Appel de la fonction fix-admin-identities...');

                const response = await fetch(`${SUPABASE_URL}/functions/v1/fix-admin-identities`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                showProgress([
                    { text: 'Connexion √† Supabase...', status: 'done' },
                    { text: 'Analyse des comptes existants', status: 'done' },
                    { text: 'Suppression des comptes cass√©s', status: 'done' },
                    { text: 'Recr√©ation avec identit√©s valides', status: 'done' },
                    { text: 'Configuration des r√¥les admin', status: 'done' },
                    { text: 'V√©rification finale', status: 'done' }
                ]);

                if (result.success) {
                    log('fix-result', '‚úÖ FIX R√âUSSI !', 'success');
                    log('fix-result', result.message, 'success');

                    if (result.credentials && result.credentials.length > 0) {
                        let credentialsHtml = '<div class="credentials"><h2 style="color: #0ff; margin-top: 0;">üìã IDENTIFIANTS CORRIG√âS</h2>';

                        result.credentials.forEach(cred => {
                            credentialsHtml += `
                                <div class="credential-item">
                                    <h3>${cred.role.toUpperCase()}</h3>
                                    <div class="credential-field"><strong>Email:</strong> ${cred.email}</div>
                                    <div class="credential-field"><strong>Username:</strong> ${cred.username}</div>
                                    <div class="credential-field"><strong>Password:</strong> ${cred.password}</div>
                                    <div class="credential-field" style="color: #0f0;"><strong>Action:</strong> ${cred.action}</div>
                                </div>
                            `;
                        });

                        credentialsHtml += '</div>';
                        document.getElementById('fix-result').innerHTML += credentialsHtml;
                    }

                    log('fix-result', '\nüìù D√©tails complets:', 'success');
                    log('fix-result', JSON.stringify(result.results, null, 2), 'success');

                    document.getElementById('test-section').style.display = 'block';
                    log('fix-result', '\n‚úÖ Vous pouvez maintenant tester les connexions ci-dessous !', 'success');
                } else {
                    log('fix-result', '‚ùå √âCHEC du fix', 'error');
                    log('fix-result', result.error || 'Erreur inconnue', 'error');
                    if (result.results) {
                        log('fix-result', JSON.stringify(result.results, null, 2), 'error');
                    }
                }

            } catch (error) {
                log('fix-result', `‚ùå EXCEPTION: ${error.message}`, 'error');
                log('fix-result', error.stack, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function testLogin(email, password) {
            clearLog('test-result');
            log('test-result', `üîê Test de connexion pour ${email}...`);

            try {
                await supabase.auth.signOut();

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    log('test-result', `‚ùå √âCHEC: ${error.message}`, 'error');
                } else {
                    log('test-result', `‚úÖ CONNEXION R√âUSSIE !`, 'success');
                    log('test-result', `User: ${data.user.email}`, 'success');
                    log('test-result', `ID: ${data.user.id}`, 'success');
                    log('test-result', `Session expires: ${new Date(data.session.expires_at * 1000)}`, 'success');
                }
            } catch (e) {
                log('test-result', `‚ùå EXCEPTION: ${e.message}`, 'error');
            }
        }

        window.onload = () => {
            console.log('üîß Page de fix charg√©e et pr√™te');
        };
    </script>
</body>
</html>
