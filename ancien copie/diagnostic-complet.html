<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagnostic Authentification BlackRaven</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #ff0;
            text-align: center;
            font-size: 2em;
            margin-bottom: 30px;
        }
        .section {
            background: #111;
            border: 2px solid #0f0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .section h2 {
            color: #ff0;
            margin-top: 0;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin: 5px;
            border-radius: 3px;
        }
        button:hover {
            background: #0ff;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .result {
            background: #222;
            border-left: 4px solid #0f0;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 12px;
        }
        .error {
            border-left-color: #f00;
            color: #f00;
        }
        .success {
            border-left-color: #0f0;
            color: #0f0;
        }
        .warning {
            border-left-color: #ff0;
            color: #ff0;
        }
        input, select {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 8px;
            font-family: 'Courier New', monospace;
            margin: 5px 0;
            width: 300px;
        }
        label {
            display: block;
            margin-top: 10px;
            color: #0ff;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DIAGNOSTIC COMPLET - AUTHENTIFICATION BLACKRAVEN</h1>

        <!-- Section 1: Configuration -->
        <div class="section">
            <h2>1Ô∏è‚É£ CONFIGURATION SUPABASE</h2>
            <button onclick="checkConfig()">V√©rifier Configuration</button>
            <div id="config-result"></div>
        </div>

        <!-- Section 2: Liste des utilisateurs -->
        <div class="section">
            <h2>2Ô∏è‚É£ UTILISATEURS DANS LA BASE</h2>
            <button onclick="listAllUsers()">Lister tous les utilisateurs</button>
            <button onclick="listAdminUsers()">Lister uniquement @k3pr0s.local</button>
            <div id="users-result"></div>
        </div>

        <!-- Section 3: Test d'authentification -->
        <div class="section">
            <h2>3Ô∏è‚É£ TEST D'AUTHENTIFICATION</h2>
            <div class="grid">
                <div>
                    <label>Email:</label>
                    <select id="test-email">
                        <option value="super_admin@k3pr0s.local">super_admin@k3pr0s.local</option>
                        <option value="admin@k3pr0s.local">admin@k3pr0s.local</option>
                        <option value="support@k3pr0s.local">support@k3pr0s.local</option>
                        <option value="superadmin@k3pr0s.local">superadmin@k3pr0s.local</option>
                    </select>
                </div>
                <div>
                    <label>Password:</label>
                    <input type="text" id="test-password" value="SuperAdmin2025!" placeholder="Entrez le mot de passe">
                </div>
            </div>
            <button onclick="testLogin()">Tester Login</button>
            <button onclick="testAllPasswords()">Tester TOUS les mots de passe possibles</button>
            <div id="login-result"></div>
        </div>

        <!-- Section 4: Session actuelle -->
        <div class="section">
            <h2>4Ô∏è‚É£ SESSION ACTUELLE</h2>
            <button onclick="checkSession()">V√©rifier Session</button>
            <button onclick="signOut()">Se D√©connecter</button>
            <div id="session-result"></div>
        </div>

        <!-- Section 5: Reset complet -->
        <div class="section">
            <h2>5Ô∏è‚É£ FIX DES IDENTIT√âS MANQUANTES</h2>
            <p style="color: #ff0;">‚ö†Ô∏è Ceci va corriger les comptes qui n'ont pas d'identit√© dans auth.identities</p>
            <button onclick="fixIdentities()">üîß FIX IDENTIT√âS</button>
            <button onclick="resetAllAdmins()">üî• RESET COMPLET (backup)</button>
            <div id="reset-result"></div>
        </div>

        <!-- Section 6: V√©rification directe SQL -->
        <div class="section">
            <h2>6Ô∏è‚É£ V√âRIFICATION SQL DIRECTE</h2>
            <button onclick="checkAuthTables()">V√©rifier tables auth.*</button>
            <button onclick="checkAdminRoles()">V√©rifier admin_roles</button>
            <div id="sql-result"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://wvfkdxdusqgzlehkcpdn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2ZmtkeGR1c3FnemxlaGtjcGRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAwNTgxMzYsImV4cCI6MjA0NTYzNDEzNn0.eLj4cZQD3f5jGG1YGTgJ7OoHB5SMVdBXMXvK-4s-K10';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(elementId, message, type = 'result') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = typeof message === 'object' ? JSON.stringify(message, null, 2) : message;
            element.appendChild(div);
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function checkConfig() {
            clearLog('config-result');
            log('config-result', 'üîç V√©rification de la configuration...');
            log('config-result', `URL: ${SUPABASE_URL}`, 'success');
            log('config-result', `ANON KEY: ${SUPABASE_ANON_KEY.substring(0, 30)}...`, 'success');

            try {
                const { data, error } = await supabase.from('admin_roles').select('count');
                if (error) {
                    log('config-result', `‚ùå Erreur connexion: ${error.message}`, 'error');
                } else {
                    log('config-result', '‚úÖ Connexion Supabase OK', 'success');
                }
            } catch (e) {
                log('config-result', `‚ùå Exception: ${e.message}`, 'error');
            }
        }

        async function listAllUsers() {
            clearLog('users-result');
            log('users-result', 'üìã R√©cup√©ration de tous les utilisateurs...');

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/get-admin-email`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                    }
                });
                const result = await response.json();
                log('users-result', result, 'success');
            } catch (e) {
                log('users-result', `‚ùå ${e.message}`, 'error');
            }
        }

        async function listAdminUsers() {
            clearLog('users-result');
            log('users-result', 'üìã Recherche des utilisateurs @k3pr0s.local...');

            const { data, error } = await supabase
                .from('admin_roles')
                .select('*');

            if (error) {
                log('users-result', `‚ùå ${error.message}`, 'error');
            } else {
                log('users-result', `‚úÖ ${data.length} r√¥les admin trouv√©s:`, 'success');
                log('users-result', data, 'success');
            }
        }

        async function testLogin() {
            clearLog('login-result');
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;

            log('login-result', `üîê Test de connexion pour ${email}...`);

            try {
                // D'abord se d√©connecter
                await supabase.auth.signOut();

                // Puis essayer de se connecter
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    log('login-result', `‚ùå ERREUR: ${error.message}`, 'error');
                    log('login-result', `D√©tails: ${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    log('login-result', '‚úÖ CONNEXION R√âUSSIE !', 'success');
                    log('login-result', `User ID: ${data.user.id}`, 'success');
                    log('login-result', `Email: ${data.user.email}`, 'success');
                    log('login-result', `Session valide jusqu'√†: ${new Date(data.session.expires_at * 1000)}`, 'success');
                    log('login-result', `M√©tadonn√©es: ${JSON.stringify(data.user.user_metadata, null, 2)}`, 'success');
                }
            } catch (e) {
                log('login-result', `‚ùå EXCEPTION: ${e.message}`, 'error');
                log('login-result', e.stack, 'error');
            }
        }

        async function testAllPasswords() {
            clearLog('login-result');
            const email = document.getElementById('test-email').value;
            const passwords = [
                'SuperAdmin2025!',
                'Admin2025!',
                'Support2025!',
                'K3pr0s2024!Admin',
                'K3pr0s2024!Support',
                'SuperAdmin2025',
                'Admin2025',
                'Support2025'
            ];

            log('login-result', `üîê Test de ${passwords.length} mots de passe pour ${email}...`);

            for (const password of passwords) {
                try {
                    await supabase.auth.signOut();
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (!error && data.user) {
                        log('login-result', `‚úÖ SUCC√àS avec: "${password}"`, 'success');
                        log('login-result', `User: ${data.user.email} (${data.user.id})`, 'success');
                        return;
                    } else {
                        log('login-result', `‚ùå √âchec: "${password}"`, 'error');
                    }
                } catch (e) {
                    log('login-result', `‚ùå Exception avec "${password}": ${e.message}`, 'error');
                }

                await new Promise(resolve => setTimeout(resolve, 500));
            }

            log('login-result', '‚ùå AUCUN mot de passe ne fonctionne !', 'error');
        }

        async function checkSession() {
            clearLog('session-result');
            log('session-result', 'üîç V√©rification de la session...');

            const { data: { session }, error } = await supabase.auth.getSession();

            if (error) {
                log('session-result', `‚ùå ${error.message}`, 'error');
            } else if (session) {
                log('session-result', '‚úÖ Session active', 'success');
                log('session-result', session, 'success');
            } else {
                log('session-result', '‚ö†Ô∏è Aucune session active', 'warning');
            }
        }

        async function signOut() {
            clearLog('session-result');
            log('session-result', 'üö™ D√©connexion...');

            const { error } = await supabase.auth.signOut();

            if (error) {
                log('session-result', `‚ùå ${error.message}`, 'error');
            } else {
                log('session-result', '‚úÖ D√©connect√© avec succ√®s', 'success');
            }
        }

        async function fixIdentities() {
            clearLog('reset-result');
            log('reset-result', 'üîß Correction des identit√©s manquantes...');

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/fix-admin-identities`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    log('reset-result', '‚úÖ Fix r√©ussi !', 'success');
                    log('reset-result', result.message, 'success');
                    log('reset-result', '\nüìã Identifiants corrig√©s:', 'success');
                    result.credentials?.forEach(cred => {
                        log('reset-result', `\n${cred.role.toUpperCase()}:\n  Email: ${cred.email}\n  Password: ${cred.password}\n  Username: ${cred.username}\n  Action: ${cred.action}`, 'success');
                    });
                } else {
                    log('reset-result', '‚ùå √âchec du fix', 'error');
                    log('reset-result', result, 'error');
                }
            } catch (e) {
                log('reset-result', `‚ùå ${e.message}`, 'error');
            }
        }

        async function resetAllAdmins() {
            if (!confirm('‚ö†Ô∏è ATTENTION: Ceci va supprimer et recr√©er tous les comptes admin. Continuer ?')) {
                return;
            }

            clearLog('reset-result');
            log('reset-result', 'üî• Reset complet en cours...');

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/setup-admin-users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    log('reset-result', '‚úÖ Reset r√©ussi !', 'success');
                    log('reset-result', result, 'success');
                    log('reset-result', '\nüìã Identifiants cr√©√©s:', 'success');
                    result.credentials?.forEach(cred => {
                        log('reset-result', `\n${cred.role.toUpperCase()}:\n  Email: ${cred.email}\n  Password: ${cred.password}\n  Username: ${cred.username}`, 'success');
                    });
                } else {
                    log('reset-result', '‚ùå √âchec du reset', 'error');
                    log('reset-result', result, 'error');
                }
            } catch (e) {
                log('reset-result', `‚ùå ${e.message}`, 'error');
            }
        }

        async function checkAuthTables() {
            clearLog('sql-result');
            log('sql-result', 'üîç V√©rification des tables auth...');
            log('sql-result', '‚ö†Ô∏è N√©cessite des permissions admin SQL', 'warning');
        }

        async function checkAdminRoles() {
            clearLog('sql-result');
            log('sql-result', 'üîç V√©rification de la table admin_roles...');

            const { data, error } = await supabase
                .from('admin_roles')
                .select('*');

            if (error) {
                log('sql-result', `‚ùå ${error.message}`, 'error');
            } else {
                log('sql-result', `‚úÖ ${data.length} r√¥les trouv√©s`, 'success');
                log('sql-result', data, 'success');
            }
        }

        // Auto-v√©rification au chargement
        window.onload = () => {
            checkConfig();
        };
    </script>
</body>
</html>
